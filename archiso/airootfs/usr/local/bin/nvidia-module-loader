#!/usr/bin/env bash
# Quick pass if one of the modules is already loaded.
if [[ -e /sys/module/nvidia || -e /sys/module/nouveau ]]; then
    exit 0
fi

# Using "install" in modprobe seems to result in no dependency resolving for
# modules, so we have to manually set the order in which all modules are loaded
# at once.
load_nvidia_modules() {
    local pkgname="$1"

    # Load some basic dependencies of nvidia modules
    modprobe video
    modprobe drm_ttm_helper
    modprobe drm_kms_helper

    for module in nvidia nvidia-modeset nvidia-drm nvidia-uvm; do
        modprobe --ignore-install "/usr/share/modules/${pkgname}/${module}.ko.zst"
    done
}

# Load compatible version of NVIDIA modules for current hardware
if (chwd --check nvidia-dkms-390xx || chwd --check nvidia-dkms-470xx || chwd --check nouveau) 2>/dev/null; then
    modprobe nouveau
elif chwd --check nvidia-dkms 2>/dev/null; then
    load_nvidia_modules linux-cachyos-nvidia
elif chwd --check nvidia-open-dkms 2>/dev/null; then
    load_nvidia_modules linux-cachyos-nvidia-open
fi

# Otherwise, do a fallback to nouveau anyway
if [[ ! -e /sys/module/nouveau && ! -e /sys/module/nvidia ]]; then
    modprobe nouveau
fi
