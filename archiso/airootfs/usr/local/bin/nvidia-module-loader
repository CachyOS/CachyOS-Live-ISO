#!/usr/bin/env bash
# Quick pass if one of the modules is already loaded.
if [[ -e /sys/module/nvidia || -e /sys/module/nouveau ]]; then
    exit 0
fi

# Load compatible version of NVIDIA modules for current hardware
if (chwd --check nouveau ||
    chwd --check nvidia-dkms-470xx ||
    chwd --check nvidia-dkms-580xx) 2>/dev/null; then
    modprobe nouveau
elif chwd --check nvidia-open-dkms 2>/dev/null; then
    # Load some basic dependencies of nvidia modules
    modprobe video
    modprobe drm_ttm_helper
    modprobe drm_kms_helper
    # load nvidia modules
    modprobe --ignore-install -a nvidia nvidia-modeset nvidia-drm nvidia-uvm
fi

# Otherwise, do a fallback to nouveau anyway
if [[ ! -e /sys/module/nouveau && ! -e /sys/module/nvidia ]]; then
    modprobe nouveau
fi
